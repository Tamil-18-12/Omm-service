<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Customer Booking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(113deg, #501F56, #19021C);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            margin: 0;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 32px;
            background: rgba(25, 2, 28, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(252, 220, 59, 0.2);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .logo img {
            height: 54px;
            width: 54px;
            border-radius: 12px;
            object-fit: cover;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 28px;
            margin: 0;
            padding: 0;
        }

        nav ul li {
            cursor: pointer;
            padding: 8px 16px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            border-radius: 22px;
            color: #ddd;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        nav ul li:hover {
            background: #fcdc3b;
            color: #3a1d59;
            box-shadow: 0 0 12px #fcdc3b;
        }

        .booking-container {
            max-width: 650px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 22px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
        }

        .booking-container h2 {
            font-weight: 800;
            text-align: center;
            margin-bottom: 30px;
            color: #fcdc3b;
            font-size: 2.5rem;
        }

        .event-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .event-info h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .slots-display {
            display: flex;
            justify-content: space-around;
        }

        .slots-display p {
            font-size: 1.1rem;
            margin: 0;
        }

        .slots-display span {
            font-weight: 700;
            font-size: 1.5rem;
            color: #fcdc3b;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #fcdc3b;
        }

        .form-control {
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: #fff;
            border-radius: 12px;
            padding: 14px;
            font-size: 1rem;
            transition: 0.3s ease;
        }

        .form-control:focus {
            background: rgba(0, 0, 0, 0.45);
            border-color: #fcdc3b;
            box-shadow: 0 0 12px rgba(252, 220, 59, 0.5);
            outline: none;
        }

        textarea.form-control {
            resize: none;
        }

        .btn-book {
            background: #fcdc3b;
            color: #3a1d59;
            font-weight: 800;
            width: 100%;
            padding: 14px;
            font-size: 1.2rem;
            border-radius: 14px;
            border: none;
            transition: 0.3s ease;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-book:hover {
            background: #e0bf2e;
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(252, 220, 59, 0.4);
        }

        #message {
            font-weight: 700;
            font-size: 1.1rem;
            margin-top: 15px;
            text-align: center;
        }
    </style>
</head>

<body>
    <nav>
        <div class="logo"><img src="https://i.ibb.co/68gP8P7/logo.png" alt="Logo" /></div>
        <ul>
            <li onclick="navigateTo('index.html')">Home</li>
            <li onclick="navigateTo('about.html')">About</li>
            <li onclick="navigateTo('contact.html')">Contact</li>
            <li onclick="navigateTo('review.html')">Review</li>
        </ul>
    </nav>

    <div class="booking-container">
        <h2>Catering Booking</h2>

        <div id="eventInfo" class="event-info">
            <h3>Booking for: <span id="eventName">Event Name</span></h3>
            <div class="slots-display">
                <p>Total Slots: <span id="totalMembers">0</span></p>
                <p>Available: <span id="availableMembers">0</span></p>
            </div>
        </div>

        <form id="bookingForm">
            <div class="form-group">
                <label for="customerName" class="form-label"><i class="fa fa-user"></i> Full Name</label>
                <input type="text" id="customerName" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="phoneNumber" class="form-label"><i class="fa fa-phone"></i> Phone Number</label>
                <input type="tel" id="phoneNumber" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="address" class="form-label"><i class="fa fa-map-marker-alt"></i> Address</label>
                <textarea id="address" class="form-control" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label for="memberInput" class="form-label"><i class="fa fa-users"></i> Number of Members</label>
                <input type="number" id="memberInput" class="form-control" min="1" required>
            </div>

            <button class="btn-book" type="submit"><i class="fa fa-calendar-check"></i> Book Now</button>
        </form>
        <p id="message"></p>
    </div>

    <script>
        function navigateTo(url) {
            window.location.href = url;
        }

        function loadBookingPanel() {
            const bookingContainer = document.querySelector('.booking-container');
            // REWRITTEN: Read from 'published_event' for consistency.
            const publishedEvent = JSON.parse(localStorage.getItem('published_event'));

            if (!publishedEvent) {
                bookingContainer.innerHTML = "<h2 style='color: #d32f2f;'>No Event Available</h2><p style='text-align: center;'>Please check back later, no event has been published by the admin.</p>";
                return;
            }

            // Populate the display with data from the correct object
            document.getElementById("eventName").textContent = publishedEvent.location; // Using location as the name
            document.getElementById("totalMembers").textContent = publishedEvent.members;
            document.getElementById("availableMembers").textContent = publishedEvent.availableSlots;
            document.getElementById("memberInput").max = publishedEvent.availableSlots;

            // If no slots are left, disable the form
            if (publishedEvent.availableSlots <= 0) {
                document.getElementById('bookingForm').style.display = 'none';
                const msg = document.getElementById('message');
                msg.textContent = "❌ All slots for this event are fully booked.";
                msg.style.color = "#d32f2f";
            }
        }

        document.getElementById("bookingForm").addEventListener('submit', function (e) {
            e.preventDefault();

            const msg = document.getElementById("message");
            const requestedMembers = parseInt(document.getElementById("memberInput").value);

            // REWRITTEN: Get the most current event data before processing
            const publishedEvent = JSON.parse(localStorage.getItem('published_event'));
            const available = publishedEvent.availableSlots;

            if (!requestedMembers || requestedMembers <= 0) {
                msg.textContent = "⚠️ Please enter a valid number of members.";
                msg.style.color = "#ffc107";
                return;
            }

            if (requestedMembers > available) {
                msg.textContent = `❌ Not enough slots available. Only ${available} left.`;
                msg.style.color = "#d32f2f";
                return;
            }

            const customerDetails = {
                bookingId: Date.now().toString(),
                customerName: document.getElementById("customerName").value,
                phoneNumber: document.getElementById("phoneNumber").value,
                address: document.getElementById("address").value,
                membersBooked: requestedMembers,
                bookedEventName: publishedEvent.location,
                bookingTimestamp: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
            };

            const allBookings = JSON.parse(localStorage.getItem('cateringBookings')) || [];
            allBookings.push(customerDetails);
            localStorage.setItem('cateringBookings', JSON.stringify(allBookings));

            // CRITICAL CHANGE: Update the available slots in the main event object
            publishedEvent.availableSlots -= requestedMembers;
            localStorage.setItem("published_event", JSON.stringify(publishedEvent));

            // Update the UI and show success message
            document.getElementById("availableMembers").textContent = publishedEvent.availableSlots;
            msg.textContent = `✅ Booking successful for ${requestedMembers} members!`;
            msg.style.color = "#28a745";

            // Hide the form to prevent multiple bookings
            document.getElementById("bookingForm").style.display = 'none';
        });

        window.onload = loadBookingPanel;
    </script>
</body>

</html>